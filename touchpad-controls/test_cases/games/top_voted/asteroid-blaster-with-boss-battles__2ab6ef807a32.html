<html>
<head>
    <title>COSMIC DEFENDER - Upgraded Asteroids Game</title>
    <script src="https://fuzzycode.dev/@cdn/resolve?url=https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
            height: 100vh;
            overflow: hidden;
        }
        #game-container {
            position: relative;
        }
        canvas {
            display: block;
        }
        @font-face {
            font-family: 'SpaceFont';
            src: url('https://fuzzycode.dev/@cdn/resolve?url=https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        }
    </style>
</head>
<body>
<div id="game-container"></div>
<script>
// Game scenes
class BootScene extends Phaser.Scene {
    constructor() {
        super({ key: 'BootScene' });
    }

    preload() {
        // Load all game assets
        this.load.image('ship', 'https://aws.fuzzycode.dev/image_buddy_365day_cache/uploads/650d0284-66ef-4e44-ba51-28913dea877c/spaceship_futuristic!resize_64x64.png');
        this.load.image('bullet', 'https://aws.fuzzycode.dev/image_buddy_365day_cache/uploads/650d0284-66ef-4e44-ba51-28913dea877c/laser_projectile!resize_16x16.png');
        this.load.image('asteroid', 'https://images.fuzzycode.dev/fast_ai?search=asteroid_rock&resize=64x64&transparency=true');
        this.load.image('background', 'https://aws.fuzzycode.dev/image_buddy_365day_cache/uploads/650d0284-66ef-4e44-ba51-28913dea877c/space_nebula_stars!resize_800x600!resize_800x600!resize_800x600!resize_800x600!resize_800x600.png');
        this.load.image('explosion', 'https://images.fuzzycode.dev/fast_ai?search=explosion_particle&resize=64x64&transparency=true');
        this.load.image('shield', 'https://images.fuzzycode.dev/fast_ai?search=energy_shield&resize=128x128&transparency=true');
        this.load.image('powerup_shield', 'https://aws.fuzzycode.dev/image_buddy_365day_cache/uploads/650d0284-66ef-4e44-ba51-28913dea877c/shield_powerup!resize_32x32.png');
        this.load.image('powerup_weapon', 'https://aws.fuzzycode.dev/image_buddy_365day_cache/uploads/650d0284-66ef-4e44-ba51-28913dea877c/weapon_powerup!resize_32x32.png');
        this.load.image('powerup_speed', 'https://images.fuzzycode.dev/fast_ai?search=speed_powerup&resize=32x32&transparency=true');
        this.load.image('boss1', 'https://aws.fuzzycode.dev/image_buddy_365day_cache/uploads/650d0284-66ef-4e44-ba51-28913dea877c/space_boss_alien!resize_128x128.png');
        this.load.image('boss2', 'https://aws.fuzzycode.dev/image_buddy_365day_cache/uploads/650d0284-66ef-4e44-ba51-28913dea877c/robot_boss_space!resize_160x160.png');
        this.load.image('boss3', 'https://aws.fuzzycode.dev/image_buddy_365day_cache/uploads/650d0284-66ef-4e44-ba51-28913dea877c/cosmic_monster_boss!resize_200x200.png');
        this.load.image('boss_bullet', 'https://images.fuzzycode.dev/fast_ai?search=enemy_laser_red&resize=24x24&transparency=true');
        this.load.image('title', 'https://aws.fuzzycode.dev/image_buddy_365day_cache/uploads/650d0284-66ef-4e44-ba51-28913dea877c/cosmic_defender_title!resize_600x200.png');
        this.load.image('stars', 'https://images.fuzzycode.dev/fast_ai?search=stars_particle&resize=16x16&transparency=true');
        
        // Load audio
        this.load.audio('shoot', 'https://sounds.fuzzycode.dev/sound_effect?prompt=laser_blaster_shoot&duration=0.5&ext=.mp3');
        this.load.audio('explosion', 'https://sounds.fuzzycode.dev/sound_effect?prompt=asteroid_explosion&duration=1&ext=.mp3');
        this.load.audio('powerup', 'https://sounds.fuzzycode.dev/sound_effect?prompt=powerup_collect&duration=0.5&ext=.mp3');
        this.load.audio('boss_appear', 'https://sounds.fuzzycode.dev/sound_effect?prompt=boss_appearance_alarm&duration=2&ext=.mp3');
        this.load.audio('boss_hit', 'https://sounds.fuzzycode.dev/sound_effect?prompt=boss_hit_impact&duration=0.5&ext=.mp3');
        this.load.audio('player_hit', 'https://sounds.fuzzycode.dev/sound_effect?prompt=ship_damage&duration=0.5&ext=.mp3');
        this.load.audio('level_complete', 'https://sounds.fuzzycode.dev/sound_effect?prompt=level_complete_success&duration=2&ext=.mp3');
        this.load.audio('game_over', 'https://sounds.fuzzycode.dev/sound_effect?prompt=game_over_failure&duration=2&ext=.mp3');
        this.load.audio('menu_music', 'https://sounds.fuzzycode.dev/music?prompt=space_game_menu_theme&duration=30&ext=.mp3');
        this.load.audio('game_music', 'https://sounds.fuzzycode.dev/music?prompt=space_battle_action_theme&duration=45&ext=.mp3');
        this.load.audio('boss_music', 'https://sounds.fuzzycode.dev/music?prompt=epic_boss_battle_theme&duration=45&ext=.mp3');

        // Loading bar
        let loadingBar = this.add.graphics({
            fillStyle: {
                color: 0x00ff00
            }
        });
        
        // Loading text
        this.loadingText = this.add.text(this.cameras.main.width / 2, this.cameras.main.height / 2 - 50, 'Loading...', {
            fontSize: '32px',
            fill: '#ffffff'
        }).setOrigin(0.5);
        
        // Update loading bar as assets load
        this.load.on('progress', (percent) => {
            loadingBar.fillRect(this.cameras.main.width / 4, this.cameras.main.height / 2, (this.cameras.main.width / 2) * percent, 30);
            this.loadingText.setText(`Loading... ${Math.round(percent * 100)}%`);
        });
        
        this.load.on('complete', () => {
            loadingBar.destroy();
            this.loadingText.destroy();
        });
    }

    create() {
        this.scene.start('TitleScene');
    }
}

class TitleScene extends Phaser.Scene {
    constructor() {
        super({ key: 'TitleScene' });
    }

    create() {
        // Background
        this.add.image(400, 300, 'background');
        
        // Particle stars effect
        this.particles = this.add.particles('stars');
        this.starEmitter = this.particles.createEmitter({
            x: { min: 0, max: 800 },
            y: 0,
            lifespan: 6000,
            speedY: { min: 30, max: 100 },
            scale: { start: 0.2, end: 0.1 },
            quantity: 2,
            blendMode: 'ADD'
        });
        
        // Title
        this.add.image(400, 150, 'title').setScale(0.8);
        
        // Start game button
        let startButton = this.add.text(400, 350, 'START GAME', {
            fontSize: '32px',
            fill: '#ffffff',
            fontStyle: 'bold',
            backgroundColor: '#222266',
            padding: { x: 20, y: 10 }
        }).setOrigin(0.5).setInteractive();
        
        // Instructions
        this.add.text(400, 450, 'Controls:\nArrows to move\nSpace to shoot', {
            fontSize: '20px',
            fill: '#ffffff',
            align: 'center'
        }).setOrigin(0.5);
        
        // Version info
        this.add.text(400, 550, 'COSMIC DEFENDER v2.0', {
            fontSize: '16px',
            fill: '#aaaaaa'
        }).setOrigin(0.5);
        
        // Animation for the start button
        this.tweens.add({
            targets: startButton,
            scale: 1.1,
            duration: 800,
            yoyo: true,
            repeat: -1
        });
        
        // Click handler
        startButton.on('pointerdown', () => {
            this.cameras.main.fade(500, 0, 0, 0);
            this.time.delayedCall(500, () => {
                // Stop menu music if playing
                if (this.sound.get('menu_music')) {
                    this.sound.get('menu_music').stop();
                }
                this.scene.start('GameScene', { level: 1 });
            });
        });
        
        // Play menu music
        if (!this.sound.get('menu_music')) {
            this.menuMusic = this.sound.add('menu_music', { loop: true, volume: 0.6 });
            this.menuMusic.play();
        }
        
        // Add ship animation
        this.ship = this.add.image(100, 300, 'ship');
        this.tweens.add({
            targets: this.ship,
            x: 700,
            y: 280,
            duration: 8000,
            ease: 'Sine.easeInOut',
            yoyo: true,
            repeat: -1,
            onYoyo: () => {
                this.ship.flipX = true;
            },
            onRepeat: () => {
                this.ship.flipX = false;
            }
        });
    }
}

class GameScene extends Phaser.Scene {
    constructor() {
        super({ key: 'GameScene' });
        this.gameOver = false;
        this.isPaused = false;
    }

    init(data) {
        this.level = data.level || 1;
        this.score = data.score || 0;
        this.lives = data.lives || 3;
        this.playerWeaponLevel = data.playerWeaponLevel || 1;
        this.playerSpeed = data.playerSpeed || 200;
    }

    create() {
        // Background
        this.background = this.add.tileSprite(400, 300, 800, 600, 'background');
        
        // Game music
        this.gameMusic = this.sound.add('game_music', { loop: true, volume: 0.4 });
        this.gameMusic.play();
        
        // Sound effects
        this.shootSound = this.sound.add('shoot');
        this.explosionSound = this.sound.add('explosion');
        this.powerupSound = this.sound.add('powerup');
        this.playerHitSound = this.sound.add('player_hit');
        this.levelCompleteSound = this.sound.add('level_complete');
        this.gameOverSound = this.sound.add('game_over');
        
        // Player
        this.createPlayer();
        
        // Bullets group
        this.bullets = this.physics.add.group({
            classType: Phaser.Physics.Arcade.Image,
            defaultKey: 'bullet',
            maxSize: 30
        });
        
        // Asteroids group
        this.asteroids = this.physics.add.group();
        
        // Explosions group
        this.explosions = this.add.group();
        
        // Powerups group
        this.powerups = this.physics.add.group();
        
        // Boss bullets group
        this.bossBullets = this.physics.add.group({
            classType: Phaser.Physics.Arcade.Image,
            defaultKey: 'boss_bullet',
            maxSize: 50
        });
        
        // Controls
        this.cursors = this.input.keyboard.createCursorKeys();
        this.shootKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
        this.pauseKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.P);
        
        // Pause handler
        this.pauseKey.on('down', () => {
            if (this.gameOver) return;
            
            if (this.isPaused) {
                this.resumeGame();
            } else {
                this.pauseGame();
            }
        });
        
        // UI
        this.createUI();
        
        // Collisions
        this.setupCollisions();
        
        // Start level
        this.startLevel(this.level);
        
        // Particle stars effect
        this.particles = this.add.particles('stars');
        this.starEmitter = this.particles.createEmitter({
            x: { min: 0, max: 800 },
            y: 0,
            lifespan: 6000,
            speedY: { min: 30, max: 100 },
            scale: { start: 0.2, end: 0.1 },
            quantity: 1,
            blendMode: 'ADD'
        });
    }

    createPlayer() {
        this.player = this.physics.add.sprite(400, 500, 'ship');
        this.player.setDrag(100);
        this.player.setAngularDrag(100);
        this.player.setMaxVelocity(this.playerSpeed);
        this.player.setCollideWorldBounds(true);
        this.player.setSize(40, 40); // Smaller hitbox for better gameplay
        this.player.body.setOffset(12, 12);
        this.player.invulnerable = false;
        this.player.shieldActive = false;
        
        // Shield sprite (initially invisible)
        this.shield = this.add.sprite(this.player.x, this.player.y, 'shield');
        this.shield.setVisible(false);
        this.shield.setScale(0.8);
        this.shield.setAlpha(0.6);
    }

    createUI() {
        // Score text
        this.scoreText = this.add.text(16, 16, 'Score: 0', { 
            fontSize: '24px', 
            fill: '#ffffff',
            fontStyle: 'bold'
        });
        
        // Level text
        this.levelText = this.add.text(400, 16, 'Level: ' + this.level, { 
            fontSize: '24px', 
            fill: '#ffffff',
            fontStyle: 'bold'
        }).setOrigin(0.5, 0);
        
        // Lives display
        this.livesText = this.add.text(750, 16, 'Lives: ' + this.lives, { 
            fontSize: '24px', 
            fill: '#ffffff', 
            fontStyle: 'bold'
        }).setOrigin(1, 0);
        
        // Weapon level indicator
        this.weaponText = this.add.text(16, 50, 'Weapon: Level ' + this.playerWeaponLevel, { 
            fontSize: '18px', 
            fill: '#ffff00' 
        });
    }

    setupCollisions() {
        // Bullet hits asteroid
        this.physics.add.collider(this.bullets, this.asteroids, this.bulletHitAsteroid, null, this);
        
        // Player hits asteroid
        this.physics.add.collider(this.player, this.asteroids, this.playerHitAsteroid, null, this);
        
        // Player collects powerup
        this.physics.add.overlap(this.player, this.powerups, this.collectPowerup, null, this);
        
        // Bullet hits boss
        this.physics.add.collider(this.bullets, this.boss, this.bulletHitBoss, null, this);
        
        // Player hits boss
        this.physics.add.collider(this.player, this.boss, this.playerHitAsteroid, null, this);
        
        // Boss bullet hits player
        this.physics.add.collider(this.bossBullets, this.player, this.bossWeaponHitPlayer, null, this);
    }

    startLevel(level) {
        // Clear any existing asteroids and powerups
        this.asteroids.clear(true, true);
        this.powerups.clear(true, true);
        
        // Level announcement
        let levelAnnouncement = this.add.text(400, 300, 'LEVEL ' + level, {
            fontSize: '64px',
            fill: '#ffffff',
            fontStyle: 'bold'
        }).setOrigin(0.5);
        
        this.tweens.add({
            targets: levelAnnouncement,
            scale: 1.5,
            alpha: 0,
            duration: 2000,
            onComplete: () => {
                levelAnnouncement.destroy();
                
                // Spawn asteroids based on level
                this.spawnAsteroids(level);
                
                // Spawn boss at specific levels
                if (level % 5 === 0) {
                    this.spawnBoss(level);
                }
            }
        });
        
        // Update level text
        this.levelText.setText('Level: ' + level);
    }

    spawnAsteroids(level) {
        const count = 5 + (level * 2);
        
        for (let i = 0; i < count; i++) {
            // Spawn asteroids away from the player
            let x, y;
            do {
                x = Phaser.Math.Between(50, 750);
                y = Phaser.Math.Between(50, 550);
            } while (Phaser.Math.Distance.Between(x, y, this.player.x, this.player.y) < 150);
            
            const asteroid = this.asteroids.create(x, y, 'asteroid');
            
            // Larger asteroids at higher levels
            const scale = Phaser.Math.FloatBetween(0.8, 1.2);
            asteroid.setScale(scale);
            
            // Random velocity
            const speed = 50 + (level * 5);
            asteroid.setVelocity(
                Phaser.Math.Between(-speed, speed),
                Phaser.Math.Between(-speed, speed)
            );
            
            // Rotation
            asteroid.setAngularVelocity(Phaser.Math.Between(-50, 50));
            
            // Physics
            asteroid.setBounce(1, 1);
            asteroid.setCollideWorldBounds(true);
            
            // Health based on size and level
            asteroid.health = Math.floor(scale * level);
            
            // Size for gameplay mechanics
            asteroid.size = scale > 0.9 ? 'large' : 'small';
        }
    }

    spawnBoss(level) {
        // Stop regular music and play boss music
        this.gameMusic.stop();
        this.bossMusic = this.sound.add('boss_music', { loop: true, volume: 0.6 });
        this.bossMusic.play();
        
        // Play boss appearance sound
        this.sound.play('boss_appear');
        
        // Boss warning text
        let warningText = this.add.text(400, 200, 'WARNING!\nBOSS APPROACHING', {
            fontSize: '48px',
            fontStyle: 'bold',
            fill: '#ff0000',
            align: 'center'
        }).setOrigin(0.5);
        
        this.tweens.add({
            targets: warningText,
            alpha: 0,
            duration: 500,
            yoyo: true,
            repeat: 5,
            onComplete: () => {
                warningText.destroy();
                
                // Determine which boss to spawn based on level
                let bossKey = 'boss1';
                if (level >= 15) {
                    bossKey = 'boss3';
                } else if (level >= 10) {
                    bossKey = 'boss2';
                }
                
                // Create boss
                this.boss = this.physics.add.sprite(400, -100, bossKey);
                this.boss.setCollideWorldBounds(true);
                
                // Boss health based on level
                this.boss.maxHealth = 50 * (Math.floor(level / 5));
                this.boss.health = this.boss.maxHealth;
                
                // Entrance animation
                this.tweens.add({
                    targets: this.boss,
                    y: 150,
                    duration: 2000,
                    ease: 'Power2',
                    onComplete: () => {
                        // Start boss attack pattern
                        this.setBossAttackPattern();
                    }
                });
                
                // Boss health bar
                this.bossHealthBar = this.add.graphics();
                this.updateBossHealthBar();
                
                // Boss name display
                const bossNames = ['Astro Destroyer', 'Galactic Sentinel', 'Cosmic Devourer'];
                const bossLevel = Math.floor(level / 5);
                const bossName = bossNames[bossLevel - 1] || bossNames[0];
                
                this.bossNameText = this.add.text(400, 50, bossName, {
                    fontSize: '28px',
                    fontStyle: 'bold',
                    fill: '#ff0000'
                }).setOrigin(0.5);
            }
        });
    }

    setBossAttackPattern() {
        // Boss movement pattern
        this.bossMoveTimer = this.time.addEvent({
            delay: 2000,
            callback: () => {
                if (!this.boss || !this.boss.active) return;
                
                const targetX = Phaser.Math.Between(100, 700);
                
                this.tweens.add({
                    targets: this.boss,
                    x: targetX,
                    duration: 1500,
                    ease: 'Sine.easeInOut'
                });
            },
            callbackScope: this,
            loop: true
        });
        
        // Boss shooting pattern
        this.bossShootTimer = this.time.addEvent({
            delay: 1000,
            callback: () => {
                if (!this.boss || !this.boss.active || this.gameOver) return;
                
                // Different attack patterns based on boss health percentage
                const healthPercent = this.boss.health / this.boss.maxHealth;
                
                if (healthPercent < 0.3) {
                    // Desperate attack - spread shot + targeted
                    this.bossDesperation();
                } else if (healthPercent < 0.6) {
                    // Medium health - spread shot
                    this.bossSpreadShot();
                } else {
                    // Full health - simple shots
                    this.bossSimpleShot();
                }
            },
            callbackScope: this,
            loop: true
        });
    }

    bossSimpleShot() {
        // Simple direct shot at player
        let bullet = this.bossBullets.get(this.boss.x, this.boss.y + 50);
        if (bullet) {
            bullet.setActive(true);
            bullet.setVisible(true);
            
            // Aim at player
            const angle = Phaser.Math.Angle.Between(
                this.boss.x, this.boss.y,
                this.player.x, this.player.y
            );
            
            this.physics.velocityFromRotation(angle, 300, bullet.body.velocity);
            bullet.setRotation(angle);
        }
    }

    bossSpreadShot() {
        // Fire 3 bullets in a spread pattern
        for (let i = -1; i <= 1; i++) {
            let bullet = this.bossBullets.get(this.boss.x, this.boss.y + 50);
            if (bullet) {
                bullet.setActive(true);
                bullet.setVisible(true);
                
                // Base angle towards player with spread
                const baseAngle = Phaser.Math.Angle.Between(
                    this.boss.x, this.boss.y,
                    this.player.x, this.player.y
                );
                const spreadAngle = baseAngle + (i * 0.3);
                
                this.physics.velocityFromRotation(spreadAngle, 300, bullet.body.velocity);
                bullet.setRotation(spreadAngle);
            }
        }
    }

    bossDesperation() {
        // Fire bullets in all directions
        for (let i = 0; i < 8; i++) {
            let bullet = this.bossBullets.get(this.boss.x, this.boss.y + 30);
            if (bullet) {
                bullet.setActive(true);
                bullet.setVisible(true);
                
                const angle = (Math.PI * 2 / 8) * i;
                this.physics.velocityFromRotation(angle, 300, bullet.body.velocity);
                bullet.setRotation(angle);
            }
        }
        
        // Plus a targeted shot
        let targetedBullet = this.bossBullets.get(this.boss.x, this.boss.y + 50);
        if (targetedBullet) {
            targetedBullet.setActive(true);
            targetedBullet.setVisible(true);
            
            const angle = Phaser.Math.Angle.Between(
                this.boss.x, this.boss.y,
                this.player.x, this.player.y
            );
            
            this.physics.velocityFromRotation(angle, 350, targetedBullet.body.velocity);
            targetedBullet.setRotation(angle);
        }
    }

    updateBossHealthBar() {
        if (!this.boss || !this.boss.active) return;
        
        this.bossHealthBar.clear();
        
        // Background bar
        this.bossHealthBar.fillStyle(0x222222, 0.8);
        this.bossHealthBar.fillRect(200, 80, 400, 20);
        
        // Health percentage
        const healthPercent = this.boss.health / this.boss.maxHealth;
        
        // Change color based on health
        let barColor = 0x00ff00; // Green
        if (healthPercent < 0.3) {
            barColor = 0xff0000; // Red
        } else if (healthPercent < 0.6) {
            barColor = 0xffff00; // Yellow
        }
        
        // Health bar
        this.bossHealthBar.fillStyle(barColor, 1);
        this.bossHealthBar.fillRect(200, 80, 400 * healthPercent, 20);
    }

    bulletHitAsteroid(bullet, asteroid) {
        // Reduce asteroid health
        asteroid.health--;
        
        // Create hit effect
        this.createExplosion(asteroid.x, asteroid.y, 0.3);
        
        // Remove the bullet
        bullet.destroy();
        
        // If asteroid is destroyed
        if (asteroid.health <= 0) {
            // Score based on asteroid size
            const scoreValue = asteroid.size === 'large' ? 20 : 10;
            this.score += scoreValue;
            this.scoreText.setText('Score: ' + this.score);
            
            // Explosion effect
            this.createExplosion(asteroid.x, asteroid.y, 1);
            this.explosionSound.play();
            
            // Chance to drop powerup
            if (Phaser.Math.Between(1, 10) <= 3) { // 30% chance
                this.dropPowerup(asteroid.x, asteroid.y);
            }
            
            // If it's a large asteroid, split into smaller ones
            if (asteroid.size === 'large' && this.level < 10) { // Don't split in higher levels to avoid too many asteroids
                for (let i = 0; i < 2; i++) {
                    const smallAsteroid = this.asteroids.create(
                        asteroid.x, 
                        asteroid.y, 
                        'asteroid'
                    );
                    
                    smallAsteroid.setScale(0.5);
                    smallAsteroid.setVelocity(
                        Phaser.Math.Between(-100, 100),
                        Phaser.Math.Between(-100, 100)
                    );
                    smallAsteroid.setAngularVelocity(Phaser.Math.Between(-100, 100));
                    smallAsteroid.setBounce(1, 1);
                    smallAsteroid.setCollideWorldBounds(true);
                    smallAsteroid.health = Math.ceil(this.level / 2);
                    smallAsteroid.size = 'small';
                }
            }
            
            // Destroy the asteroid
            asteroid.destroy();
            
            // Check if level is complete
            if (this.asteroids.countActive() === 0 && (!this.boss || !this.boss.active)) {
                this.levelComplete();
            }
        }
    }

    bulletHitBoss(bullet, boss) {
        // Create hit effect
        this.createExplosion(bullet.x, bullet.y, 0.5);
        
        // Remove the bullet
        bullet.destroy();
        
        // Play boss hit sound
        this.sound.play('boss_hit');
        
        // Reduce boss health
        boss.health -= this.playerWeaponLevel;
        
        // Flash boss red when hit
        this.tweens.add({
            targets: boss,
            alpha: 0.7,
            duration: 50,
            yoyo: true
        });
        
        // Update boss health bar
        this.updateBossHealthBar();
        
        // Check if boss is defeated
        if (boss.health <= 0) {
            // Big explosion effect
            for (let i = 0; i < 10; i++) {
                this.time.delayedCall(i * 200, () => {
                    const offsetX = Phaser.Math.Between(-50, 50);
                    const offsetY = Phaser.Math.Between(-50, 50);
                    this.createExplosion(boss.x + offsetX, boss.y + offsetY, 1.5);
                });
            }
            
            // Play explosion sound
            this.explosionSound.play();
            
            // Award score
            this.score += 500 * Math.floor(this.level / 5);
            this.scoreText.setText('Score: ' + this.score);
            
            // Clear boss attack timers
            if (this.bossMoveTimer) this.bossMoveTimer.remove();
            if (this.bossShootTimer) this.bossShootTimer.remove();
            
            // Clear boss health bar and name
            if (this.bossHealthBar) this.bossHealthBar.clear();
            if (this.bossNameText) this.bossNameText.destroy();
            
            // Stop boss music and resume game music
            if (this.bossMusic) this.bossMusic.stop();
            this.gameMusic.play();
            
            // Destroy the boss
            boss.destroy();
            
            // Drop multiple powerups
            for (let i = 0; i < 3; i++) {
                this.dropPowerup(
                    boss.x + Phaser.Math.Between(-50, 50),
                    boss.y + Phaser.Math.Between(-50, 50)
                );
            }
            
            // Check if level is complete
            if (this.asteroids.countActive() === 0) {
                this.levelComplete();
            }
        }
    }

    playerHitAsteroid(player, asteroid) {
        // If player is invulnerable, just bounce off
        if (player.invulnerable) {
            // Push the asteroid away
            const angle = Phaser.Math.Angle.Between(player.x, player.y, asteroid.x, asteroid.y);
            asteroid.body.velocity.x = Math.cos(angle) * 200;
            asteroid.body.velocity.y = Math.sin(angle) * 200;
            return;
        }
        
        // If shield is active, deactivate it instead of losing a life
        if (player.shieldActive) {
            player.shieldActive = false;
            this.shield.setVisible(false);
            
            // Make player briefly invulnerable
            this.makePlayerInvulnerable(2000);
            
            // Create hit effect
            this.createExplosion(player.x, player.y, 1);
            this.playerHitSound.play();
            
            return;
        }
        
        // Lose a life
        this.lives--;
        this.livesText.setText('Lives: ' + this.lives);
        
        // Play hit sound
        this.playerHitSound.play();
        
        // Create explosion effect
        this.createExplosion(player.x, player.y, 1);
        
        // Make player briefly invulnerable
        this.makePlayerInvulnerable(3000);
        
        // Check for game over
        if (this.lives <= 0) {
            this.gameOver = true;
            this.gameOverSound.play();
            
            // Stop all music
            this.gameMusic.stop();
            if (this.bossMusic) this.bossMusic.stop();
            
            // Stop the player
            player.setVelocity(0, 0);
            player.setAcceleration(0, 0);
            
            // Game over text
            const gameOverText = this.add.text(400, 250, 'GAME OVER', {
                fontSize: '64px',
                fontStyle: 'bold',
                fill: '#ff0000'
            }).setOrigin(0.5);
            
            // Final score
            this.add.text(400, 350, 'Final Score: ' + this.score, {
                fontSize: '32px',
                fill: '#ffffff'
            }).setOrigin(0.5);
            
            // Return to title button
            const returnButton = this.add.text(400, 450, 'Return to Title', {
                fontSize: '24px',
                fill: '#ffffff',
                backgroundColor: '#222266',
                padding: { x: 20, y: 10 }
            }).setOrigin(0.5).setInteractive();
            
            returnButton.on('pointerdown', () => {
                this.scene.start('TitleScene');
            });
            
            // Animation
            this.tweens.add({
                targets: gameOverText,
                scale: 1.2,
                duration: 1000,
                yoyo: true,
                repeat: -1
            });
        }
    }

    bossWeaponHitPlayer(player, bullet) {
        // Destroy the bullet
        bullet.destroy();
        
        // Same logic as asteroid hit
        this.playerHitAsteroid(player, {x: bullet.x, y: bullet.y});
    }

    makePlayerInvulnerable(duration) {
        this.player.invulnerable = true;
        
        // Visual feedback - blinking effect
        this.invulnerabilityTween = this.tweens.add({
            targets: this.player,
            alpha: 0.5,
            duration: 100,
            yoyo: true,
            repeat: duration / 200,
            onComplete: () => {
                this.player.invulnerable = false;
                this.player.setAlpha(1);
            }
        });
    }

    dropPowerup(x, y) {
        // Choose a random powerup type
        const types = ['shield', 'weapon', 'speed'];
        const type = types[Phaser.Math.Between(0, 2)];
        
        const powerup = this.powerups.create(x, y, 'powerup_' + type);
        powerup.type = type;
        
        // Add some movement
        powerup.setVelocity(
            Phaser.Math.Between(-50, 50),
            Phaser.Math.Between(-50, 50)
        );
        
        // Add rotation
        powerup.setAngularVelocity(30);
        
        // Make it bounce off walls
        powerup.setBounce(1);
        powerup.setCollideWorldBounds(true);
        
        // Glowing effect
        this.tweens.add({
            targets: powerup,
            scale: 1.2,
            duration: 500,
            yoyo: true,
            repeat: -1
        });
        
        // Auto-destroy after some time
        this.time.delayedCall(10000, () => {
            if (powerup.active) {
                powerup.destroy();
            }
        });
    }

    collectPowerup(player, powerup) {
        // Play powerup sound
        this.powerupSound.play();
        
        // Apply effect based on powerup type
        switch (powerup.type) {
            case 'shield':
                player.shieldActive = true;
                this.shield.setVisible(true);
                
                // Auto-disable shield after 15 seconds
                this.time.delayedCall(15000, () => {
                    if (player.shieldActive) {
                        player.shieldActive = false;
                        this.shield.setVisible(false);
                    }
                });
                break;
                
            case 'weapon':
                this.playerWeaponLevel = Math.min(this.playerWeaponLevel + 1, 5);
                this.weaponText.setText('Weapon: Level ' + this.playerWeaponLevel);
                break;
                
            case 'speed':
                this.playerSpeed = Math.min(this.playerSpeed + 30, 350);
                player.setMaxVelocity(this.playerSpeed);
                break;
        }
        
        // Create collection effect
        this.createExplosion(powerup.x, powerup.y, 0.5);
        
        // Destroy the powerup
        powerup.destroy();
    }

    createExplosion(x, y, scale = 1) {
        const explosion = this.add.sprite(x, y, 'explosion');
        explosion.setScale(scale);
        
        // Random rotation
        explosion.setRotation(Phaser.Math.FloatBetween(0, Math.PI * 2));
        
        // Animation
        this.tweens.add({
            targets: explosion,
            scale: scale * 2,
            alpha: 0,
            duration: 300,
            onComplete: () => {
                explosion.destroy();
            }
        });
    }

    levelComplete() {
        // Play level complete sound
        this.levelCompleteSound.play();
        
        // Level complete text
        const levelCompleteText = this.add.text(400, 300, 'LEVEL COMPLETE!', {
            fontSize: '48px',
            fontStyle: 'bold',
            fill: '#ffffff'
        }).setOrigin(0.5);
        
        // Animation
        this.tweens.add({
            targets: levelCompleteText,
            scale: 1.5,
            duration: 1000,
            yoyo: true,
            onComplete: () => {
                levelCompleteText.destroy();
                
                // Start next level
                this.level++;
                this.startLevel(this.level);
            }
        });
    }

    pauseGame() {
        this.isPaused = true;
        this.physics.pause();
        
        // Pause all tweens
        this.tweens.pauseAll();
        
        // Pause all timers
        this.time.paused = true;
        
        // Pause music
        this.gameMusic.pause();
        if (this.bossMusic) this.bossMusic.pause();
        
        // Pause text
        this.pauseText = this.add.text(400, 300, 'GAME PAUSED', {
            fontSize: '48px',
            fontStyle: 'bold',
            fill: '#ffffff'
        }).setOrigin(0.5);
        
        // Resume instructions
        this.resumeText = this.add.text(400, 350, 'Press P to resume', {
            fontSize: '24px',
            fill: '#ffffff'
        }).setOrigin(0.5);
    }

    resumeGame() {
        this.isPaused = false;
        this.physics.resume();
        
        // Resume all tweens
        this.tweens.resumeAll();
        
        // Resume all timers
        this.time.paused = false;
        
        // Resume music
        this.gameMusic.resume();
        if (this.bossMusic) this.bossMusic.resume();
        
        // Remove pause text
        this.pauseText.destroy();
        this.resumeText.destroy();
    }

    update() {
        if (this.gameOver || this.isPaused) return;
        
        // Update background
        this.background.tilePositionY -= 0.5;
        
        // Player movement
        if (this.cursors.left.isDown) {
            this.player.setAngularVelocity(-150);
        } else if (this.cursors.right.isDown) {
            this.player.setAngularVelocity(150);
        } else {
            this.player.setAngularVelocity(0);
        }

        if (this.cursors.up.isDown) {
            this.physics.velocityFromRotation(this.player.rotation - Math.PI/2, this.playerSpeed, this.player.body.acceleration);
            
            // Create thruster particles if accelerating
            if (!this.thrusterEmitter) {
                this.thrusterEmitter = this.particles.createEmitter({
                    scale: { start: 0.2, end: 0 },
                    speed: 20,
                    lifespan: 300,
                    blendMode: 'ADD',
                    follow: this.player
                });
            }
        } else {
            this.player.setAcceleration(0);
            
            // Stop thruster particles if not accelerating
            if (this.thrusterEmitter) {
                this.thrusterEmitter.stop();
                this.thrusterEmitter = null;
            }
        }
        
        // Shooting
        if (Phaser.Input.Keyboard.JustDown(this.shootKey)) {
            this.shoot();
        }
        
        // Update shield position to follow player
        if (this.shield && this.player.shieldActive) {
            this.shield.x = this.player.x;
            this.shield.y = this.player.y;
            
            // Rotate shield for visual effect
            this.shield.rotation += 0.01;
        }
        
        // Wrap sprites around screen edges
        this.physics.world.wrap(this.player, 32);
        
        this.bullets.children.each(function(bullet) {
            this.physics.world.wrap(bullet, 16);
        }, this);
        
        this.asteroids.children.each(function(asteroid) {
            this.physics.world.wrap(asteroid, 32);
        }, this);
        
        this.powerups.children.each(function(powerup) {
            this.physics.world.wrap(powerup, 16);
        }, this);
        
        this.bossBullets.children.each(function(bullet) {
            // Remove boss bullets that go off screen instead of wrapping
            if (bullet.x < 0 || bullet.x > 800 || bullet.y < 0 || bullet.y > 600) {
                bullet.destroy();
            }
        }, this);
    }

    shoot() {
        this.shootSound.play();
        
        // Different shooting patterns based on weapon level
        switch (this.playerWeaponLevel) {
            case 1:
                // Single bullet
                this.fireBullet(0);
                break;
                
            case 2:
                // Double bullet
                this.fireBullet(-5);
                this.fireBullet(5);
                break;
                
            case 3:
                // Triple bullet
                this.fireBullet(-10);
                this.fireBullet(0);
                this.fireBullet(10);
                break;
                
            case 4:
                // Quad bullet
                this.fireBullet(-15);
                this.fireBullet(-5);
                this.fireBullet(5);
                this.fireBullet(15);
                break;
                
            case 5:
                // Spread + powerful center
                this.fireBullet(-20);
                this.fireBullet(-10);
                this.fireBullet(0, 1.5);  // Stronger center bullet
                this.fireBullet(10);
                this.fireBullet(20);
                break;
        }
    }

    fireBullet(angleOffset = 0, scaleMultiplier = 1) {
        const bullet = this.bullets.get(this.player.x, this.player.y);
        
        if (bullet) {
            bullet.setActive(true);
            bullet.setVisible(true);
            
            // Calculate direction based on player rotation plus offset
            const angle = this.player.rotation - Math.PI/2 + Phaser.Math.DegToRad(angleOffset);
            
            // Set velocity
            this.physics.velocityFromRotation(angle, 500, bullet.body.velocity);
            
            // Set rotation to match direction
            bullet.setRotation(angle);
            
            // Scale bullet for visual effect
            bullet.setScale(scaleMultiplier);
            
            // Auto-destroy after time
            this.time.delayedCall(2000, () => {
                if (bullet.active) {
                    bullet.destroy();
                }
            });
        }
    }
}

// Game configuration
const config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    parent: 'game-container',
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { x: 0, y: 0 },
            debug: false
        }
    },
    scene: [BootScene, TitleScene, GameScene],
    pixelArt: false,
    backgroundColor: '#000000'
};

const game = new Phaser.Game({
    ...config,
    preserveDrawingBuffer: true // This will override the initial value
});
</script>
</body>
</html>