<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disco Dance Battle</title>
    <script src="https://cdn.fuzzycode.dev/resolve?url=https://unpkg.com/kaboom@next/dist/kaboom.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <script>
        kaboom({
            background: [25, 0, 51], // Deep purple background for disco vibe
        })

        // Load disco-themed sprites
        loadSprite("discoball", "https://aws.fuzzycode.dev/image_buddy_365day_cache/uploads/650d0284-66ef-4e44-ba51-28913dea877c/disco ball!resize_64x64.png")
        loadSprite("dancer1", "https://aws.fuzzycode.dev/image_buddy_365day_cache/uploads/650d0284-66ef-4e44-ba51-28913dea877c/disco dancer silhouette!resize_64x64.png")
        loadSprite("dancer2", "https://aws.fuzzycode.dev/image_buddy_365day_cache/uploads/650d0284-66ef-4e44-ba51-28913dea877c/breakdancer silhouette!resize_64x64_4030d6e70f.png")
        loadSprite("record", "https://images.fuzzycode.dev/fast_ai?search=vinyl%20record&resize=64x64&transparency=true")
        loadSprite("spotlight", "https://aws.fuzzycode.dev/image_buddy_365day_cache/uploads/650d0284-66ef-4e44-ba51-28913dea877c/stage spotlight!resize_64x64_3ebedb0661!resize_64x64.png")
        loadSprite("boombox", "https://images.fuzzycode.dev/fast_ai?search=retro%20boombox&resize=64x64&transparency=true")
        loadSprite("glowstick", "https://aws.fuzzycode.dev/image_buddy_365day_cache/uploads/650d0284-66ef-4e44-ba51-28913dea877c/glowstick!resize_64x64.png")
        loadSprite("discofloor", "https://aws.fuzzycode.dev/image_buddy_365day_cache/uploads/650d0284-66ef-4e44-ba51-28913dea877c/disco dance floor pattern!resize_64x64.png")

        loadSprite("player", "https://aws.fuzzycode.dev/image_buddy_365day_cache/uploads/650d0284-66ef-4e44-ba51-28913dea877c/disco dancer with afro!resize_64x64.png")
        loadSound("hit", "https://sounds.fuzzycode.dev/sound?query=hit.mp3")
        loadSound("shoot", "https://sounds.fuzzycode.dev/sound_effect?prompt=disco%20sound%20effect&duration=0.5&ext=.mp3")
        loadSound("explode", "https://sounds.fuzzycode.dev/sound_effect?prompt=dance%20floor%20explosion&duration=1&ext=.mp3")
        loadSound("DiscoGroove", "https://sounds.fuzzycode.dev/music?prompt=upbeat%20disco%20funk%20music&duration=30&ext=.mp3")
        loadSound("victory", "https://sounds.fuzzycode.dev/sound_effect?prompt=disco%20victory%20fanfare&duration=2&ext=.mp3")

        scene("battle", () => {

            const BULLET_SPEED = 1200
            const TRASH_SPEED = 120
            const BOSS_SPEED = 48
            const PLAYER_SPEED = 480
            const STAR_SPEED = 120
            const BOSS_HEALTH = 100
            const OBJ_HEALTH = 4

            const objs = [
                "discoball",
                "dancer1",
                "dancer2",
                "record",
                "spotlight",
                "boombox",
                "glowstick",
            ]

            const bossName = choose(objs)

            let insaneMode = false

            const music = play("DiscoGroove")

            volume(0.5)

            function grow(rate) {
                return {
                    update() {
                        const n = rate * dt()
                        this.scale.x += n
                        this.scale.y += n
                    },
                }
            }

            function late(t) {
                let timer = 0
                return {
                    add() {
                        this.hidden = true
                    },
                    update() {
                        timer += dt()
                        if (timer >= t) {
                            this.hidden = false
                        }
                    },
                }
            }

            add([
                text("DANCE", { size: 160 }),
                pos(width() / 2, height() / 2),
                anchor("center"),
                lifespan(1),
                fixed(),
                color(255, 0, 255),
            ])

            add([
                text("BATTLE", { size: 80 }),
                pos(width() / 2, height() / 2),
                anchor("center"),
                lifespan(2),
                late(1),
                fixed(),
                color(0, 255, 255),
            ])

            add([
                text("VS " + bossName.toUpperCase(), { size: 120 }),
                pos(width() / 2, height() / 2),
                anchor("center"),
                lifespan(4),
                late(2),
                fixed(),
                color(255, 255, 0),
            ])

            // Disco floor background
            for (let x = 0; x < width(); x += 64) {
                for (let y = 0; y < height(); y += 64) {
                    add([
                        sprite("discofloor"),
                        pos(x, y),
                        opacity(0.2),
                        scale(1),
                        "floor"
                    ])
                }
            }

            const sky = add([
                rect(width(), height()),
                color(0, 0, 0),
                opacity(0),
            ])

            sky.onUpdate(() => {
                if (insaneMode) {
                    const t = time() * 10
                    sky.color.r = wave(127, 255, t)
                    sky.color.g = wave(127, 255, t + 1)
                    sky.color.b = wave(127, 255, t + 2)
                    sky.opacity = 0.7
                } else {
                    sky.color = rgb(0, 0, 0)
                    sky.opacity = 0
                }
            })

            // Update disco floor to flash in sync with music
            onUpdate("floor", (floor) => {
                const t = time() * 2
                if (insaneMode) {
                    floor.opacity = wave(0.1, 0.8, t)
                    floor.color = rgb(
                        wave(0, 255, t), 
                        wave(0, 255, t + 1), 
                        wave(0, 255, t + 2)
                    )
                } else {
                    floor.opacity = wave(0.1, 0.3, t)
                }
            })

            const player = add([
                sprite("player"),
                area(),
                pos(width() / 2, height() - 64),
                anchor("center"),
            ])

            onKeyDown("left", () => {
                player.move(-PLAYER_SPEED, 0)
                if (player.pos.x < 0) {
                    player.pos.x = width()
                }
            })

            onKeyDown("right", () => {
                player.move(PLAYER_SPEED, 0)
                if (player.pos.x > width()) {
                    player.pos.x = 0
                }
            })

            onKeyPress("up", () => {
                insaneMode = true
                music.speed = 2
            })

            onKeyRelease("up", () => {
                insaneMode = false
                music.speed = 1
            })

            player.onCollide("enemy", (e) => {
                destroy(e)
                destroy(player)
                shake(120)
                play("explode")
                music.detune = -1200
                addExplode(center(), 12, 120, 30)
                wait(1, () => {
                    music.paused = true
                    go("battle")
                })
            })

            function addExplode(p, n, rad, size) {
                for (let i = 0; i < n; i++) {
                    wait(rand(n * 0.1), () => {
                        for (let i = 0; i < 2; i++) {
                            add([
                                pos(p.add(rand(vec2(-rad), vec2(rad)))),
                                rect(4, 4),
                                scale(1 * size, 1 * size),
                                lifespan(0.1),
                                grow(rand(48, 72) * size),
                                anchor("center"),
                                color(rand(0, 255), rand(0, 255), rand(0, 255))
                            ])
                        }
                    })
                }
            }

            function spawnBullet(p) {
                add([
                    rect(12, 48),
                    area(),
                    pos(p),
                    anchor("center"),
                    color(255, 0, 255), // Disco purple
                    outline(4, rgb(0, 255, 255)), // Cyan outline
                    move(UP, BULLET_SPEED),
                    offscreen({ destroy: true }),
                    "bullet",
                ])
            }

            onUpdate("bullet", (b) => {
                if (insaneMode) {
                    b.color = rand(rgb(0, 0, 0), rgb(255, 255, 255))
                } else {
                    // Cycle through disco colors
                    const t = time() * 10
                    b.color.r = wave(0, 255, t)
                    b.color.g = wave(0, 255, t + 2)
                    b.color.b = wave(0, 255, t + 4)
                }
            })

            onKeyPress("space", () => {
                spawnBullet(player.pos.sub(16, 0))
                spawnBullet(player.pos.add(16, 0))
                play("shoot", {
                    volume: 0.3,
                    detune: rand(-1200, 1200),
                })
            })

            function spawnTrash() {
                const name = choose(objs.filter(n => n != bossName))
                add([
                    sprite(name),
                    area(),
                    pos(rand(0, width()), 0),
                    health(OBJ_HEALTH),
                    anchor("bot"),
                    "trash",
                    "enemy",
                    { speed: rand(TRASH_SPEED * 0.5, TRASH_SPEED * 1.5) },
                ])
                wait(insaneMode ? 0.1 : 0.3, spawnTrash)
            }

            const boss = add([
                sprite(bossName),
                area(),
                pos(width() / 2, 40),
                health(BOSS_HEALTH),
                scale(3),
                anchor("top"),
                "enemy",
                {
                    dir: 1,
                },
            ])

            on("death", "enemy", (e) => {
                destroy(e)
                shake(2)
                addKaboom(e.pos)
            })

            on("hurt", "enemy", (e) => {
                shake(1)
                play("hit", {
                    detune: rand(-1200, 1200),
                    speed: rand(0.2, 2),
                })
            })

            const timer = add([
                text(0),
                pos(12, 32),
                fixed(),
                { time: 0 },
                color(255, 255, 0), // Yellow disco text
            ])

            timer.onUpdate(() => {
                timer.time += dt()
                timer.text = timer.time.toFixed(2)
            })

            onCollide("bullet", "enemy", (b, e) => {
                destroy(b)
                e.hurt(insaneMode ? 10 : 1)
                addExplode(b.pos, 1, 24, 1)
            })

            onUpdate("trash", (t) => {
                t.move(0, t.speed * (insaneMode ? 5 : 1))
                if (t.pos.y - t.height > height()) {
                    destroy(t)
                }
                // Make dancers rotate
                t.angle += dt() * 100 * (insaneMode ? 3 : 1)
            })

            boss.onUpdate((p) => {
                boss.move(BOSS_SPEED * boss.dir * (insaneMode ? 3 : 1), 0)
                if (boss.dir === 1 && boss.pos.x >= width() - 20) {
                    boss.dir = -1
                }
                if (boss.dir === -1 && boss.pos.x <= 20) {
                    boss.dir = 1
                }
                // Make boss rotate for disco effect
                boss.angle = wave(-15, 15, time() * 4)

                // Scale pulse effect
                const scaleFactor = wave(2.9, 3.1, time() * 8)
                boss.scale = vec2(scaleFactor, scaleFactor)
            })

            boss.onHurt(() => {
                healthbar.set(boss.hp())
            })

            boss.onDeath(() => {
                music.stop()
                go("win", {
                    time: timer.time,
                    boss: bossName,
                })
            })

            const healthbar = add([
                rect(width(), 24),
                pos(0, 0),
                color(255, 0, 255), // Disco purple
                fixed(),
                {
                    max: BOSS_HEALTH,
                    set(hp) {
                        this.width = width() * hp / this.max
                        this.flash = true
                    },
                },
            ])

            healthbar.onUpdate(() => {
                if (healthbar.flash) {
                    healthbar.color = rgb(255, 255, 255)
                    healthbar.flash = false
                } else {
                    // Cycle through disco colors
                    const t = time() * 5
                    healthbar.color.r = wave(100, 255, t)
                    healthbar.color.g = wave(0, 150, t + 2)
                    healthbar.color.b = wave(100, 255, t + 4)
                }
            })

            add([
                text("UP: DANCE FEVER MODE", { width: width() / 2, size: 32 }),
                anchor("botleft"),
                pos(24, height() - 24),
                color(0, 255, 255), // Cyan text
            ])

            spawnTrash()

        })

            scene("win", ({ time: finalTime, boss }) => {

                const victoryMusic = play("victory", {
                    loop: true,
                    volume: 0.8
                })
            loop(1, () => {
                victoryMusic.detune = rand(-300, 300)
            })

            add([
                sprite(boss),
                color(255, 0, 255), // Disco purple
                anchor("center"),
                scale(8),
                pos(width() / 2, height() / 2),
                "winner"
            ])

            // Make the winner spin
            onUpdate("winner", (w) => {
                w.angle += dt() * 60
                // Cycle through disco colors
                const t = time() * 10
                w.color.r = wave(100, 255, t)
                w.color.g = wave(0, 255, t + 2)
                w.color.b = wave(100, 255, t + 4)
            })

            // Add disco floor tiles in the background
            for (let x = 0; x < width(); x += 64) {
                for (let y = 0; y < height(); y += 64) {
                    add([
                        sprite("discofloor"),
                        pos(x, y),
                        opacity(0.5),
                        scale(1),
                        "floor"
                    ])
                }
            }

            // Update disco floor to flash
            onUpdate("floor", (floor) => {
                const t = time() * 2
                floor.opacity = wave(0.3, 0.7, t)
                floor.color = rgb(
                    wave(0, 255, t), 
                    wave(0, 255, t + 1), 
                    wave(0, 255, t + 2)
                )
            })

            add([
                text("DANCE CHAMPION!", { size: 48 }),
                anchor("center"),
                pos(width() / 2, height() / 2 - 120),
                color(255, 255, 0), // Yellow
            ])

            add([
                text("TIME: " + finalTime.toFixed(2), { size: 32 }),
                anchor("center"),
                pos(width() / 2, height() / 2 + 120),
                color(0, 255, 255), // Cyan
            ])

        })

        go("battle")
    </script>
</body>
</html>